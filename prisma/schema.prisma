// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql" // Mantenha postgresql
    url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// MODELOS DE AUTENTICAÇÃO E TENANT (IGREJA)
// --------------------------------------------------------

// A "Igreja" ou Cliente do seu SaaS
model Tenant {
    id          String   @id @default(cuid())
    name        String
    slug        String   @unique
    
    city        String?  // Ex: Jacobina
    state       String?  // Ex: BA
    // --- NOVOS CAMPOS ---
    description String?  // Descrição ou Lema da Igreja
    logoUrl     String?  // Link da imagem do logo
    // --------------------

    plan        Plan     @default(FREE)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    users        User[]
    members      Member[]
    categories   Category[]
    transactions transaction[]
    accounts     Account[]
    staff        Staff[]      // Relacionamento com Staff (que criamos antes)
    staffRoles   StaffRole[]  // Relacionamento com Cargos (que criamos antes)
    accountPayables AccountPayable[]

    @@map("tenants")
}

enum Plan {
    FREE
    PRO
    ENTERPRISE
}

// O Usuário do Sistema (Pastor, Tesoureiro)
model User {
    id            String    @id @default(cuid())
    name          String?
    email         String    @unique
    password      String?
    emailVerified DateTime?
    image         String?
    role          Role      @default(USER)
    
    // Link com a Igreja (Tenant)
    tenantId      String?   
    tenant        Tenant?   @relation(fields: [tenantId], references: [id])

    // Tabelas padrão do NextAuth (para login com Google/Github se precisar)
    accounts      NextAuthAccount[]
    sessions      Session[]

    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    @@index([tenantId])
    @@map("users")
}

enum Role {
    USER      // Apenas visualiza
    TREASURER // Pode lançar
    ADMIN     // Pode tudo
}

// --------------------------------------------------------
// MODELOS FINANCEIROS (O CORAÇÃO DO SISTEMA)
// --------------------------------------------------------

// Membros (Dizimistas)
model Member {
    id        String   @id @default(cuid())
    name      String
    phone     String?
    email     String?
    birthDate DateTime?
    
    tenantId  String
    tenant    Tenant   @relation(fields: [tenantId], references: [id])

    transactions transaction[] // Histórico de dízimos deste membro

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([tenantId]) // Vital para performance (buscar membros só dessa igreja)
    @@map("members")
}

// Plano de Contas (Categorias: Dízimo, Oferta, Luz, Aluguel)
model Category {
    id        String   @id @default(cuid())
    name      String
    type      TransactionType // ENTRADA ou SAIDA
    
    tenantId  String
    tenant    Tenant   @relation(fields: [tenantId], references: [id])

    transactions transaction[]
    accountPayables AccountPayable[]

    @@index([tenantId])
    @@map("categories")
}

// Contas Bancárias / Caixas
model Account {
    id        String   @id @default(cuid())
    name      String   // Ex: "Cofre", "Banco do Brasil"
    initialBalance Decimal @default(0) // Saldo inicial ao começar usar o sistema
    
    tenantId  String
    tenant    Tenant   @relation(fields: [tenantId], references: [id])

    transactions transaction[]

    @@index([tenantId])
    @@map("accounts")
}

// Lançamentos (Entradas e Saídas)
model transaction {
    id          String   @id @default(cuid())
    description String?  // Descrição opcional (ex: "Compra de Pães")
    amount      Decimal  @db.Decimal(10, 2) // Dinheiro SEMPRE Decimal. (10 digitos, 2 casas decimais)
    date        DateTime @default(now()) // Data do fato gerador
    type        TransactionType
    
    // Relacionamentos
    tenantId    String
    tenant      Tenant   @relation(fields: [tenantId], references: [id])

    categoryId  String
    category    Category @relation(fields: [categoryId], references: [id])

    accountId   String
    account     Account  @relation(fields: [accountId], references: [id])

    memberId    String?  // Opcional: Só preenche se for dízimo identificado
    member      Member?  @relation(fields: [memberId], references: [id])

    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@index([tenantId])
    @@index([date])
    @@map("transactions")
}

enum TransactionType {
    INCOME  // Entrada
    EXPENSE // Saída
}

// --------------------------------------------------------
// TABELAS PADRÃO DO NEXT-AUTH (Autenticação)
// --------------------------------------------------------
// Não mude isso se for usar NextAuth, são obrigatórias.

model NextAuthAccount {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@map("next_auth_accounts")
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@map("sessions")
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
    @@map("verification_tokens")
}

model StaffRole {
    id        String   @id @default(cuid())
    name      String   // Ex: "Pastor", "Tesoureiro", "Zelador"
    
    tenantId  String
    tenant    Tenant   @relation(fields: [tenantId], references: [id])
    
    staff     Staff[]  // Quem tem esse cargo

    @@index([tenantId])
}

model Staff {
    id        String   @id @default(cuid())
    name      String
    
    roleId    String
    role      StaffRole @relation(fields: [roleId], references: [id])
    
    phone     String?
    email     String?

    // Dados Financeiros
    isSalaried Boolean  @default(false)
    salary     Decimal? @default(0)     // Salário Bruto
    inss       Decimal? @default(0)     // Valor INSS (R$)
    fgts       Decimal? @default(0)     // Valor FGTS (R$)
    

    otherTaxes Decimal? @default(0)     // Outras Taxas (em %)
    
    tenantId  String
    tenant    Tenant   @relation(fields: [tenantId], references: [id])
    paymentDay Int?     // Dia do mês (1 a 31)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([tenantId])
}

model AccountPayable {
    id          String   @id @default(cuid())
    description String
    amount      Decimal  @db.Decimal(10, 2)
    dueDate     DateTime // Data de Vencimento
    
    // Status do Pagamento
    isPaid      Boolean  @default(false)
    paidAt      DateTime? // Data que foi pago efetivamente
    
    // Relacionamentos
    categoryId  String
    category    Category @relation(fields: [categoryId], references: [id])
    
    tenantId    String
    tenant      Tenant   @relation(fields: [tenantId], references: [id])

    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@index([tenantId])
    @@index([dueDate])
}